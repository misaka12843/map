


===当前地图============

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>恋爱冒险地图</title>
    <meta name="darkreader-lock">

    <link rel="preconnect" href="https://fontsapi.zeoseven.com" crossorigin>
        
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<script src="https://cdn.cbd.int/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

<style>
    @import url("https://fontsapi.zeoseven.com/214/main/result.css");
    @import url("https://fontsapi.zeoseven.com/480/main/result.css");
    :root {
        --font-title: "TsangerFeiBai W03", "Sarasa UI SC", "Microsoft YaHei", sans-serif;
        --font-main: "Sarasa UI SC", "Microsoft YaHei", sans-serif;
        --font-ui: "Sarasa UI SC", "Microsoft YaHei", sans-serif;
        --font-size-base: 13px;
        --font-size-small: 0.9rem;
        --font-size-large: 1.1rem;
        --spacing-xs: 5px;
        --spacing-sm: 8px;
        --spacing-md: 12px;
        --spacing-lg: 20px;
        --spacing-xl: 30px;
        --border-radius-xs: 3px;
        --border-radius-sm: 5px;
        --border-radius-md: 8px;
        --border-radius-lg: 12px;
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: 300ms cubic-bezier(0.5, -0.5, 0.25, 1.5);
        --c-shadow-color: rgba(84, 84, 84, 0.12);
        --shadow-sm: 0 2px 4px var(--c-shadow-color);
        --shadow-md: 0 4px 10px var(--c-shadow-color);
        --shadow-lg: 0 8px 20px var(--c-shadow-color);
        --c-background-primary: #ffffff;
        --c-background-secondary: #f6f8fa;
        --c-background-tertiary: #eaeef2;
        --c-text-primary: #24292f;
        --c-text-secondary: #57606a;
        --c-text-inverted: #ffffff;
        --c-border-primary: #d0d7de;
        --c-border-secondary: #b4bbc2;
        --c-accent-primary: #0969da;
        --c-accent-secondary: #388bfd;
        --c-button-success-bg: #2da44e;
        --c-button-success-hover-bg: #2c974b;
        --c-gradient-start: #ffffff;
        --c-gradient-end: #f6f8fa;
        --scrollbar-width: 8px;
    }
    html {
        box-sizing: border-box;
        color: var(--c-text-primary);
        transition: color var(--transition-normal);
    }
    *, *::before, *::after {
        box-sizing: inherit;
    }
    html[data-theme='dark'] {
        --c-shadow-color: rgba(0, 0, 0, 0.25);
        --c-background-primary: #2c313a;
        --c-background-secondary: #3e4451;
        --c-background-tertiary: #505663;
        --c-text-primary: #e6e6e6;
        --c-text-secondary: #b0b0b0;
        --c-text-inverted: #222222;
        --c-border-primary: #606673;
        --c-border-secondary: #7a8292;
        --c-accent-primary: #e8a85e;
        --c-accent-secondary: #f5c58a;
        --c-button-success-bg: #7cb342;
        --c-button-success-hover-bg: #8fd352;
        --c-gradient-start: #505663;
        --c-gradient-end: #3e4451;
    }
    body {
        background-color: var(--c-background-primary);
        transition: background-color var(--transition-normal);
        margin: 0;
        font-family: var(--font-main);
        font-size: var(--font-size-base);
        overflow-x: hidden;
    }
    .page-collapser {
        position: sticky;
        top: 0;
        width: 100%;
        z-index: 999;
        background-color: var(--c-background-secondary);
        border-bottom: 1px solid var(--c-border-primary);
        box-shadow: var(--shadow-sm);
        text-align: center;
        transition: background-color var(--transition-normal), border-color var(--transition-normal);
    }
    .map-wrapper {
        display: block;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding-top: 10px;
        padding-bottom: 10px;
    }
    
    .map-wrapper > * {
        transition: opacity 0.3s ease-out, transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body.is-collapsed .map-wrapper {
        max-height: 0;
        overflow: hidden;
        padding-top: 0;
        padding-bottom: 0;
    }
    
    body.is-collapsed .map-wrapper > * {
        opacity: 0;
        transform: translateY(-15px);
        pointer-events: none;
    }

    #collapse-toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--spacing-xs) var(--spacing-lg);
        font-family: var(--font-ui);
        font-size: var(--font-size-small);
        color: var(--c-text-secondary);
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        transition: color var(--transition-fast);
    }
    #collapse-toggle-btn:hover {
        color: var(--c-accent-primary);
    }
    #collapse-toggle-btn i {
        transition: transform var(--transition-normal);
    }
    #collapse-toggle-btn .label-expand {
        display: none;
    }
    body.is-collapsed #collapse-toggle-btn .label-expand {
        display: inline;
    }
    body.is-collapsed #collapse-toggle-btn .label-collapse {
        display: none;
    }
    body.is-collapsed #collapse-toggle-btn i {
        transform: rotate(180deg);
    }
    .map-interface {
        max-width: 100%;
        width: 100%;
        margin: 0 auto;
        background: var(--c-background-primary); 
        border: 2px solid var(--c-border-primary);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        padding: var(--spacing-lg);
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
        display: none;
        flex-direction: column;
        transition: all var(--transition-normal);
        max-height: 1000vh;
    }
    .map-interface.show {
        display: flex !important;
    }
    .map-wrapper.is-loading {
        position: relative;
        min-height: 300px; /* 避免加载时高度塌陷 */
    }
    .map-wrapper.is-loading > .map-interface {
        visibility: hidden; /* 加载时隐藏真实UI，但保留布局 */
    }
    .map-wrapper.is-loading::before {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--c-background-primary);
        z-index: 10;
        border-radius: var(--border-radius-md);
    }
    .map-wrapper.is-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        margin-top: -20px;
        border: 4px solid var(--c-border-primary);
        border-top-color: var(--c-accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 11;
    }
    .map-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        text-align: center; 
        margin-bottom: 15px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid var(--c-border-primary); 
        flex-shrink: 0; 
    }
    .map-header h2 { 
        font-size: 1.85rem; 
        margin: 0; 
        color: var(--c-accent-secondary); 
        font-family: var(--font-title); 
    }
    .header-info { 
        font-family: var(--font-ui); 
        font-size: var(--font-size-small); 
        color: var(--c-text-secondary); 
    }
    .top-right-buttons { 
        display: flex; 
        gap: 10px; 
    }
    .current-partners-section, .external-areas-section { 
        margin-bottom: 15px; 
        padding: 15px; 
        background-color: color-mix(in srgb, var(--c-accent-primary) 10%, transparent); 
        border: 1px solid var(--c-accent-primary); 
        border-radius: var(--border-radius-md); 
        flex-shrink: 0; 
    }
    .current-partners-section.hidden, .external-areas-section.hidden { 
        display: none; 
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }
    .section-title { 
        font-family: var(--font-ui); 
        color: var(--c-accent-secondary); 
        font-weight: bold; 
        flex-shrink: 0;
    }
    #visual-map-container {
        position: relative;
        width: 100%;
        border: 2px solid var(--c-border-primary);
        background: linear-gradient(135deg, var(--c-gradient-start), var(--c-gradient-end));
        border-radius: var(--border-radius-md);
        overflow: hidden;
        height: clamp(300px, 40vh, 500px);
        min-height: 300px; 
        margin-bottom: 15px;
        box-sizing: border-box;
        cursor: grab;
        transition: border-color var(--transition-normal);
    }
    #visual-map-container:focus-within {
        border-color: var(--c-accent-primary);
        outline: 2px solid color-mix(in srgb, var(--c-accent-primary) 20%, transparent);
        outline-offset: 0.5px;
    }
    #visual-map-container.is-dragging { 
        cursor: grabbing; 
    }
    #visual-map {
        display: block;
        width: 100%;
        height: 100%;
        touch-action: none;
        user-select: none;
    }
    #visual-map .svg-pan-zoom_viewport {
        transition: transform 0.05s linear;
        will-change: transform;
    }
    .gradient-stop-1 { stop-color: var(--c-gradient-start); }
    .gradient-stop-2 { stop-color: var(--c-gradient-end); }
    .map-location-group {
        cursor: pointer;
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
        will-change: transform;
    }
    .map-location-group:hover {
        transform: translateY(-3px);
    }
    .map-location-group:focus {
        outline: 2px solid var(--c-accent-primary);
        outline-offset: 2px;
    }
    .map-location-rect {
        fill: url(#locationGradient);
        stroke: var(--c-border-primary);
        stroke-width: 1.5px; /* 增加边框宽度作为补偿 */
        transition: all var(--transition-normal);
    }
    .map-location-group:hover .map-location-rect {
        stroke: var(--c-accent-secondary);
        stroke-width: 2.5px;
    }
    .map-location-label {
        fill: var(--c-text-primary);
        text-anchor: middle;
        dominant-baseline: middle;
        pointer-events: none;
        user-select: none;
        font-weight: 600;
        font-family: var(--font-ui);
        paint-order: stroke;
        stroke: var(--c-background-primary);
        stroke-width: 4px; /* 增加文字描边宽度以提升可读性 */
        stroke-linecap: round;
        stroke-linejoin: round;
        transition: all var(--transition-normal);
        font-size: clamp(16px, calc(sqrt(var(--room-area, 25000)) * 0.08px), 40px);
    }
    html:not([data-theme='dark']) .map-location-label {
        fill: var(--c-text-secondary);
        stroke: var(--c-background-secondary);
        stroke-width: 2px;
    }
    .map-location-group:hover .map-location-label { 
        fill: var(--c-accent-secondary); 
    }
    
    @keyframes pulse-glow-enhanced {
        0%, 100% {
            stroke: var(--c-accent-primary);
            filter: drop-shadow(0 0 6px var(--c-accent-primary));
        }
        50% {
            stroke: var(--c-accent-secondary);
            filter: drop-shadow(0 0 12px var(--c-accent-secondary));
        }
    }
    .map-location-group.is-current-location .map-location-rect {
        stroke-width: 2.5px;
        animation: pulse-glow-enhanced 2.2s infinite ease-in-out;
    }
    .map-location-group.is-current-location .map-location-label {
        fill: var(--c-accent-secondary);
        font-weight: 700;
    }

    .map-location-icon {
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        fill: var(--c-accent-secondary);
        font-size: 18px;
        pointer-events: none;
    }
    .map-custom-controls { 
        position: absolute; 
        top: 50%; 
        right: 15px; 
        transform: translateY(-50%); 
        z-index: 10; 
        display: flex; 
        flex-direction: column; 
        gap: var(--spacing-sm); 
        background-color: color-mix(in srgb, var(--c-background-primary) 75%, transparent); 
        border: 1px solid var(--c-border-primary); 
        border-radius: var(--border-radius-md); 
        padding: var(--spacing-sm); 
        backdrop-filter: blur(4px); 
        box-shadow: var(--shadow-md); 
    }
    .map-custom-controls button { 
        background-color: var(--c-background-tertiary); 
        border: 1px solid var(--c-border-primary); 
        color: var(--c-text-primary); 
        width: 36px; 
        height: 36px; 
        border-radius: var(--border-radius-sm); 
        cursor: pointer; 
        font-size: 16px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast); 
        transform: translateZ(0);
    }
    .map-custom-controls button:hover { 
        background-color: var(--c-background-secondary); 
        color: var(--c-accent-secondary); 
        transform: scale(1.05) translateZ(0); 
    }
    .map-custom-controls button:active { 
        transform: scale(0.95) translateZ(0); 
    }
    .modal-overlay { 
        position: fixed; 
        inset: 0; 
        background-color: color-mix(in srgb, var(--c-background-primary) 30%, transparent); 
        z-index: 1000; 
        display: grid; 
        place-items: center; 
        padding: 20px 10px; 
        opacity: 1; 
        visibility: visible; 
        transition: opacity var(--transition-normal), visibility var(--transition-normal); 
    }
    .modal-overlay.hidden { 
        opacity: 0; 
        visibility: hidden; 
        pointer-events: none; 
    }
    body.modal-open .map-interface {
        filter: blur(3px);
        pointer-events: none;
        user-select: none;
    }
    body.modal-open {
        overflow: hidden;
        padding-right: var(--scrollbar-width);
    }
    html.modal-open-html {
        overflow: hidden;
    }

    .modal-dialog {
        box-sizing: border-box;
        background-color: color-mix(in srgb, var(--c-background-primary) 75%, transparent);
        border: 1px solid color-mix(in srgb, var(--c-border-primary) 50%, transparent);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(12px);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg) var(--spacing-xl);
        width: min(90vw, 500px);
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        transform: scale(1);
        opacity: 1;
        transition: transform var(--transition-bounce), opacity var(--transition-normal);
        will-change: transform, opacity;
    }
    #character-modal .modal-content { flex-grow: 1; overflow-y: auto; max-height: 70vh; padding-right: 10px; margin-right: -10px; scrollbar-width: thin; scrollbar-color: var(--c-border-primary) transparent; }
    #character-modal .interaction-options-grid { 
        border-top: 1px solid var(--c-border-primary); 
        padding-top: var(--spacing-lg); 
        margin-top: var(--spacing-lg); 
        min-height: 50px; 
        align-items: stretch;
    }

    .modal-overlay.hidden .modal-dialog { transform: scale(0.95); opacity: 0; }
    .shop-modal-dialog, .inventory-modal-dialog, .character-modal-dialog, .task-modal-dialog { max-width: 450px; padding: 25px 30px; }
    .modal-dialog h4 { font-family: var(--font-title); font-size: 1.6rem; color: var(--c-accent-secondary); text-align: center; margin-top: 5px; margin-bottom: var(--spacing-lg); }
    .modal-content {
        overflow-y: auto;
        overscroll-behavior: contain;
        scroll-behavior: smooth;
        transform: translateZ(0);
        -webkit-overflow-scrolling: touch;
    }
    .close-modal-button { position: absolute; top: 10px; right: 12px; background: none; border: none; font-size: 26px; color: var(--c-text-secondary); cursor: pointer; z-index: 10; transition: transform var(--transition-fast); }
    .close-modal-button:active { transform: scale(0.9); }
    .modal-actions { 
        margin-top: auto; 
        padding-top: 15px; 
        border-top: 1px solid var(--c-border-primary); 
        display: flex;
        justify-content: center; 
        align-items: center;   
        gap: var(--spacing-md);
    }
    .modal-section-title { font-family: var(--font-ui); font-size: 1rem; color: var(--c-accent-primary); margin-top: var(--spacing-lg); margin-bottom: var(--spacing-md); text-align: center; border-top: 1px solid var(--c-border-primary); padding-top: 15px; }
    #modal-character-name { font-size: 2.2rem; margin-bottom: var(--spacing-lg); text-align: center; align-self: center; }
    #confirm-modal-text, #alert-modal-text { font-family: var(--font-ui); margin: var(--spacing-lg) 0; font-size: var(--font-size-large); line-height: 1.5; color: var(--c-text-primary); white-space: pre-wrap; }
    .confirm-modal-buttons { display: flex; justify-content: space-around; gap: var(--spacing-lg); margin-top: 10px; }
    .confirm-modal-buttons .confirm { background-color: var(--c-button-success-bg); color: var(--c-text-inverted); }
    #confirm-modal-cancel-btn { background-color: transparent; border: 1px solid var(--c-border-secondary); color: var(--c-text-secondary); flex-grow: 1; }
    #confirm-modal-cancel-btn:hover { background-color: var(--c-background-secondary); color: var(--c-text-primary); }
    #confirm-modal-confirm-btn { flex-grow: 1; }
    .partner-button-list, .external-area-buttons { display: flex; flex-wrap: wrap; gap: 10px; }

    .partner-button, .interaction-button, .sub-location-button, .use-button {
        background-color: var(--c-background-tertiary);
        color: var(--c-text-primary);
        border: 1px solid var(--c-border-primary);
        border-radius: var(--border-radius-sm);
        padding: 10px 15px;
        font-family: var(--font-ui);
        font-size: 14px;
        cursor: pointer;
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform var(--transition-fast), background-color var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-normal);
        transform: translateY(0) translateZ(0); 
    }
    .interaction-button {
        height: auto; 
        min-height: 40px; 
        white-space: normal; 
        word-break: break-word; 
        display: flex;
    }
    .partner-button, .interaction-button, .sub-location-button, .use-button, .external-area-button {
        will-change: transform, box-shadow, border-color, background-color; 
    }
    .partner-button:hover, .interaction-button:hover, .sub-location-button:hover, .use-button:hover, .external-area-button:hover {
        transform: translateY(-2px) translateZ(0); 
        box-shadow: var(--shadow-md);
        border-color: var(--c-accent-secondary); 
    }
    .partner-button:active, .external-area-button:active, .interaction-button:active, .sub-location-button:active, .use-button:active {
        transform: scale(0.96) translateY(0); 
        box-shadow: none; 
    }
    .partner-button:focus-visible, .interaction-button:focus-visible, .sub-location-button:focus-visible, .use-button:focus-visible, .external-area-button:focus-visible { outline: 2px solid var(--c-accent-primary); outline-offset: 2px; }
    .partner-button { padding: 5px 12px; font-size: 1rem; gap: var(--spacing-sm); }
    .partner-button i { margin-right: 6px; color: var(--c-accent-primary); }
    .use-button { background-color: var(--c-button-success-bg); color: var(--c-text-inverted); border: none; padding: 6px 12px; white-space: nowrap; }
    .use-button:hover { background-color: var(--c-button-success-hover-bg); }
    .external-area-button { background-color: transparent; border: 1px dashed var(--c-border-primary); color: var(--c-text-secondary); font-size: 1rem; padding: 7px 14px; transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast); }
    .external-area-button i { margin-right: 6px; color: var(--c-text-secondary); transition: color var(--transition-fast); }
    .external-area-button:hover { background-color: var(--c-background-secondary); color: var(--c-text-primary); border-style: solid; }
    .external-area-button:hover i { color: var(--c-accent-primary); }
    .interaction-button.is-loading, .use-button.is-loading { pointer-events: none; opacity: 0.65; position: relative; }
    .interaction-button.is-loading::after, .use-button.is-loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; margin-top: -8px; margin-left: -8px; border: 2px solid rgba(255, 255, 255, 0.2); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .attributes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; text-align: center; }
    .attribute-item { background-color: var(--c-background-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius-sm); font-family: var(--font-ui); }
    .attribute-item-label { font-size: var(--font-size-small); color: var(--c-text-secondary); }
    .attribute-item-value { font-size: var(--font-size-large); font-weight: bold; color: var(--c-accent-secondary); }
    .interaction-options-grid, .sub-location-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--spacing-md); }
    #skill-items-container, #inventory-items-container, #task-items-container {
        margin-top: 15px;
        flex-grow: 1;
        flex-shrink: 1;
        min-height: 0;
        overscroll-behavior: contain;
        overflow-y: auto;
        scrollbar-gutter: stable;
    }
    .shop-item, .inventory-item, .task-item, .skill-item { font-family: var(--font-ui); background-color: var(--c-background-tertiary); border: 1px solid var(--c-border-primary); border-radius: var(--border-radius-sm); padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .task-item { display: block; }
    .task-item-header { font-weight: bold; margin-bottom: 5px; color: var(--c-accent-secondary); }
    .task-item-details { font-size: var(--font-size-small); color: var(--c-text-secondary); }
    .modal-empty-state { font-family: var(--font-ui); color: var(--c-text-secondary); padding: var(--spacing-lg) 0; text-align: center; font-size: var(--font-size-small); }
    #character-search-container {
        flex-grow: 1;
        display: flex;
        justify-content: flex-end;
    }
    .character-search-input { 
        width: 100%; 
        padding: 8px 12px; 
        background-color: var(--c-background-secondary); 
        border: 1px solid var(--c-border-primary); 
        border-radius: var(--border-radius-sm); 
        color: var(--c-text-primary); 
        font-family: var(--font-ui); 
        transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        outline: none;
    }
    .character-search-input:focus {
        border-color: var(--c-accent-primary);
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--c-accent-primary) 20%, transparent);
    }
    .character-search-input::placeholder { 
        color: var(--c-text-secondary); 
    }
    #search-toggle-btn {
        background-color: transparent;
        border: none;
        color: var(--c-text-secondary);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px 8px;
        border-radius: var(--border-radius-sm);
        transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    #search-toggle-btn:hover {
        color: var(--c-accent-primary);
        background-color: var(--c-background-tertiary);
    }
    .current-partners-section.search-mode-compact #character-search-input {
        display: none;
    }
    .current-partners-section.search-mode-full #search-toggle-btn {
        display: none;
    }
    #important-character-buttons .partner-button { 
        padding: 5px 12px 5px 6px; 
    }
    .partner-button .avatar { 
        width: 28px; 
        height: 28px; 
        border-radius: 50%; 
        object-fit: cover; 
        background-color: var(--c-background-primary); 
        border: 1px solid var(--c-border-primary); 
    }
    .avatar-fallback { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-family: var(--font-ui); 
        font-size: 14px; 
        font-weight: bold; 
        color: var(--c-accent-secondary); 
    }
    #external-areas .section-title {
        margin-bottom: var(--spacing-md);
    }
    .list-item-enter {
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .list-item-enter-active {
        opacity: 1;
        transform: scale(1);
    }


    .partner-button-list, 
    .external-area-buttons,
    #important-character-buttons,
    #modal-interaction-options,
    .sub-location-grid {
        overflow: hidden;
        padding-top: 4px;
    }


    .partner-button-list, 
    .external-area-buttons {
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .partner-button-list::-webkit-scrollbar,
    .external-area-buttons::-webkit-scrollbar {
        display: none;
    }

    * { scrollbar-width: thin; scrollbar-color: var(--c-border-primary) var(--c-background-secondary); }
    ::-webkit-scrollbar {
        width: var(--scrollbar-width);
        height: var(--scrollbar-width);
    }

    ::-webkit-scrollbar-track { background: var(--c-background-secondary); border-radius: var(--border-radius-sm); }
    ::-webkit-scrollbar-thumb { background-color: var(--c-background-tertiary); border-radius: var(--border-radius-sm); border: 1px solid var(--c-border-primary); }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--c-accent-primary); }
    @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }
    @media (prefers-contrast: high) { :root, html[data-theme='dark'] { --c-border-primary: currentColor; --c-text-primary: CanvasText; --c-text-secondary: CanvasText; --c-background-primary: Canvas; --c-background-secondary: Canvas; --c-background-tertiary: Canvas; --c-accent-primary: LinkText; --c-accent-secondary: LinkText; } }
    @media (max-width: 768px) {
        :root { --font-size-base: 12px; --spacing-md: 10px; --spacing-lg: 15px; }
        body { padding: 5px; }
        .map-interface {display: none; }
        .map-header { flex-direction: column; gap: var(--spacing-md); }
        .map-header h2 { font-size: 1.5rem; }
        .top-right-buttons { order: -1; width: 100%; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .top-right-buttons .partner-button { flex-grow: 1; justify-content: center; }
        #visual-map-container { height: 38vh; min-height: 220px; }
        .partner-button-list, .external-area-buttons { display: flex; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; flex-shrink: 0; white-space: nowrap; }
        .partner-button-list::-webkit-scrollbar, .external-area-buttons::-webkit-scrollbar { display: none; }
        .partner-button { padding: 8px 14px; font-size: 0.9rem; flex-shrink: 0; white-space: nowrap; }
        #important-character-buttons .partner-button { padding: 5px 10px 5px 5px; }
        .sub-location-grid { grid-template-columns: 1fr; }
        .modal-dialog { width: 95vw; padding: var(--spacing-lg) 15px; }
        .modal-dialog h4 { font-size: 1.3rem; }
        #modal-character-name { font-size: 1.7rem; }
        .attributes-grid { grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); }
        .attribute-item { padding: var(--spacing-xs); }
        .interaction-options-grid { grid-template-columns: 1fr; gap: var(--spacing-sm); }
        .interaction-button, .sub-location-button { padding: 10px; font-size: 0.95rem; }
        .shop-item, .inventory-item, .skill-item { flex-direction: column; align-items: center; gap: 10px; }
        .shop-item > div, .inventory-item > div, .skill-item > div { text-align: center; }
        .use-button { width: auto; padding-left: 40px; padding-right: 40px; }
    }
</style>

</head>
<body>
        <div class="page-collapser">
            <button id="collapse-toggle-btn" title="收起/展开小地图" aria-expanded="true">
                <span class="label-collapse">收起小地图</span>
                <span class="label-expand">展开小地图</span>
                <i class="fas fa-chevron-up" aria-hidden="true"></i>
            </button>
        </div>
    <div class="map-wrapper">

        <div class="map-interface">
            <div class="map-header">
                <h2 id="map-title"></h2>
                <div class="header-info"><span id="map-time"></span></div>
                <div class="top-right-buttons">
                    <button id="theme-toggle-btn" class="partner-button" title="切换主题">
                        <i class="fas fa-sun"></i> 
                    </button>
                    <button class="partner-button" id="skill-button"><i class="fas fa-book"></i> 技能<span class="notification-badge"></span></button>
                    <button class="partner-button" id="inventory-button"><i class="fas fa-briefcase"></i> 背包<span class="notification-badge"></span></button>
                    <button class="partner-button" id="task-button"><i class="fas fa-tasks"></i> 任务<span class="notification-badge"></span></button>
                </div>
            </div>
            <div id="current-important-characters" class="current-partners-section hidden">
                <div class="section-header">
                    <div class="section-title"><i class="fas fa-star"></i> 当前地图重要人物</div>
                    <div id="character-search-container">
                        <input type="search" id="character-search-input" placeholder="搜索人物..." class="character-search-input">
                        <button id="search-toggle-btn" title="搜索人物">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="important-character-buttons" class="partner-button-list"></div>
            </div>
            <div id="visual-map-container">
                <svg id="visual-map" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg"></svg>
                <div class="map-custom-controls">
                    <button id="zoom-in-btn" title="放大"><i class="fas fa-plus"></i></button>
                    <button id="zoom-out-btn" title="缩小"><i class="fas fa-minus"></i></button>
                    <button id="reset-zoom-btn" title="重置视图"><i class="fas fa-expand"></i></button>
                </div>
            </div>
            <div id="external-areas" class="external-areas-section hidden">
                <div class="section-title"><i class="fas fa-globe-asia"></i> 可前往的外部区域</div>
                <div id="external-area-buttons" class="external-area-buttons"></div>
            </div>
        </div>
    </div>
    
    <div id="character-modal" class="modal-overlay hidden"><div class="modal-dialog character-modal-dialog"><button class="close-modal-button">&times;</button><h4 id="modal-character-name"></h4><div id="modal-character-description" class="modal-content"></div><div id="modal-interaction-options" class="interaction-options-grid"></div></div></div>
    <div id="skill-modal" class="modal-overlay hidden"><div class="modal-dialog shop-modal-dialog"><button class="close-modal-button">&times;</button><h4><i class="fas fa-book"></i> 技能</h4><div id="skill-items-container"></div></div></div>
    <div id="inventory-modal" class="modal-overlay hidden"><div class="modal-dialog inventory-modal-dialog"><button class="close-modal-button">&times;</button><h4><i class="fas fa-briefcase"></i> 背包</h4><div id="inventory-items-container"></div></div></div>
    <div id="task-modal" class="modal-overlay hidden"><div class="modal-dialog task-modal-dialog"><button class="close-modal-button">&times;</button><h4><i class="fas fa-tasks"></i> 当前任务</h4><div id="task-items-container"></div></div></div>
    <div id="confirm-modal" class="modal-overlay hidden"><div class="modal-dialog confirm-modal-dialog"><h4>请确认操作</h4><div id="confirm-modal-text" class="modal-content"></div><div class="confirm-modal-buttons"><button id="confirm-modal-cancel-btn" class="interaction-button">取消</button><button id="confirm-modal-confirm-btn" class="interaction-button confirm">确认</button></div></div></div>
    <div id="alert-modal" class="modal-overlay hidden"><div class="modal-dialog confirm-modal-dialog"><h4>提示</h4><div id="alert-modal-text" class="modal-content"></div><div class="confirm-modal-buttons"><button id="alert-modal-ok-btn" class="interaction-button confirm">好的</button></div></div></div>
    <div id="main-location-modal" class="modal-overlay hidden"><div class="modal-dialog"><button class="close-modal-button">&times;</button><h4 id="modal-main-loc-name" style="text-align:center;"></h4><div id="modal-main-loc-content" class="modal-content"></div><div id="modal-main-loc-actions" class="modal-actions"></div></div></div>
    <div id="sub-location-modal" class="modal-overlay hidden"><div class="modal-dialog"><button class="close-modal-button">&times;</button><h4 id="modal-sub-loc-name" style="text-align:center;"></h4><div id="modal-sub-loc-content" class="modal-content"></div><div id="modal-sub-loc-actions" class="modal-actions"></div></div></div>
    <div id="map-element-modal" class="modal-overlay hidden"><div class="modal-dialog"><button class="close-modal-button">&times;</button><h4 id="modal-element-name" style="text-align:center;"></h4><div id="modal-element-description" class="modal-content"></div><div id="modal-element-interactions" class="interaction-options-grid"></div></div></div>

<script>
    const DOMManager = {
        initialized: false,
    
        init() {
            if (this.initialized) {
                console.log('[MapApp] DOM管理器已初始化，跳过重复执行');
                return;
            }
            this.initialized = true;
            console.log('[MapApp] DOM管理器开始初始化...');
            
            this.initCollapseToggle();
            this.initThemeToggle();
            this.initSearchToggle();
            this.initMapApp();
        },
    
        initCollapseToggle() {
            const collapseBtn = document.getElementById('collapse-toggle-btn');
            if (!collapseBtn) {
                console.warn('[MapApp] 折叠按钮未找到');
                return;
            }

            const toggleCollapse = () => {
                const isCurrentlyCollapsed = document.body.classList.contains('is-collapsed');
                collapseBtn.setAttribute('aria-expanded', isCurrentlyCollapsed);
            
                if (isCurrentlyCollapsed) {
                    console.log("[MapApp] 用户点击展开小地图");
                    document.body.classList.remove('is-collapsed');
                    this.handleExpand();
                } else {
                    console.log("[MapApp] 用户点击收起小地图");
                    document.body.classList.add('is-collapsed');
                }
                this.saveCollapseState();
            };

            collapseBtn.addEventListener('click', toggleCollapse);
            this.restoreCollapseState();
        },
    
        handleExpand() {
            const mapInterfaceEl = document.querySelector('.map-interface');
            if (!mapInterfaceEl) return;

            const isMapAppReady = window.MapApp && window.MapApp.state && window.MapApp.state.mapData;
            
            console.log("[MapApp] 展开检查 - MapApp数据就绪:", !!isMapAppReady);
        
            if (isMapAppReady) {
                mapInterfaceEl.classList.add('show');
                // PanZoom is initialized on first load, but might need resizing if the container was hidden.
                setTimeout(() => {
                    if (window.MapApp?.state.panZoomInstance) {
                        window.MapApp.state.panZoomInstance.resize();
                        window.MapApp.state.panZoomInstance.center();
                    } else if (window.MapApp?.initializePanZoomWithRetry) {
                        // If it wasn't initialized for some reason (e.g. error), try again.
                        window.MapApp.initializePanZoomWithRetry();
                    }
                }, 100);
            } else {
                console.log("[MapApp] 数据尚未就绪，等待自动加载完成。");
            }
        },
    
        saveCollapseState() {
            try {
                localStorage.setItem('mapCollapsed', document.body.classList.contains('is-collapsed'));
            } catch (e) {
                console.warn('无法保存折叠状态到 localStorage');
            }
        },
    
        restoreCollapseState() {
            try {
                const isCollapsed = localStorage.getItem('mapCollapsed') === 'true';
                document.body.classList.toggle('is-collapsed', isCollapsed);
                console.log(`[MapApp] 页面初始化：恢复状态为 ${isCollapsed ? '收起' : '展开'}`);
                
                if (!isCollapsed) {
                    // If it's expanded by default, call handleExpand to check if content is ready to be shown.
                    this.handleExpand();
                }
            } catch (e) {
                console.warn('无法从 localStorage 恢复折叠状态。默认展开。');
                document.body.classList.remove('is-collapsed');
                this.handleExpand();
            }
        },

        initThemeToggle() {
            const themeToggleButton = document.getElementById('theme-toggle-btn');
            if (!themeToggleButton) return;
            const themeIcon = themeToggleButton.querySelector('i');
            if (!themeIcon) return;

            const sunIconClass = 'fa-sun';
            const moonIconClass = 'fa-moon';

            const getCurrentTheme = () => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                try {
                    localStorage.setItem('theme', theme);
                } catch (e) { console.warn('无法保存主题到localStorage'); }
                themeIcon.classList.toggle(moonIconClass, theme === 'dark');
                themeIcon.classList.toggle(sunIconClass, theme !== 'dark');
            };

            themeToggleButton.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light');
            });
            applyTheme(getCurrentTheme());
        },

        initSearchToggle() {
            const searchToggleBtn = document.getElementById('search-toggle-btn');
            const searchInput = document.getElementById('character-search-input');
            const section = document.getElementById('current-important-characters');
            if (!searchToggleBtn || !searchInput || !section) return;

            const setSearchView = (mode) => {
                section.classList.toggle('search-mode-full', mode === 'full');
                section.classList.toggle('search-mode-compact', mode !== 'full');
            };
            searchToggleBtn.addEventListener('click', () => { setSearchView('full'); searchInput.focus(); });
            searchInput.addEventListener('blur', () => { if (searchInput.value.trim() === '') setSearchView('compact'); });
            setSearchView('compact');
        },
    
        initMapApp() {
            if (window.MapAppMainInitialized) {
                console.warn('[MapApp] 主应用脚本已初始化，阻止重复执行。');
                return;
            }
            window.MapAppMainInitialized = true;
            setTimeout(() => SafeMapAppInitializer.init(), 1000);
        }
    };

    window.MapApp = {
        config: {
            selectors: {
                mapInterface: '.map-interface',
                mapTitle: '#map-title', mapTime: '#map-time', skillBtn: '#skill-button', inventoryBtn: '#inventory-button', taskBtn: '#task-button',
                importantCharsSection: '#current-important-characters', importantCharsContainer: '#important-character-buttons',
                characterSearchInput: '#character-search-input', visualMapContainer: '#visual-map-container',
                visualMap: '#visual-map', externalAreasSection: '#external-areas', externalAreasContainer: '#external-area-buttons',
                modals: '.modal-overlay', closeModalBtns: '.modal-overlay .close-modal-button'
            },
            api: {
                getData: () => {
                    if (typeof parent.stMemoryEnhancement?.ext_exportAllTablesAsJson === 'function') {
                        return parent.stMemoryEnhancement.ext_exportAllTablesAsJson();
                    }
                    console.error("无法访问 parent.stMemoryEnhancement.ext_exportAllTablesAsJson");
                    throw new Error("无法访问记忆插件的API。");
                },
                sendCommand: (command) => {
                    if (typeof triggerSlash === 'function') {
                        try {
                            triggerSlash(`/send ${command} || /trigger`);
                        } catch (e) {
                            window.MapApp.UI.showAlert(e.toString());
                        }
                    } else {
                        console.warn("`triggerSlash` 未定义，模拟发送指令:", command);
                        window.MapApp.UI.showAlert(`模拟发送：\n${command}`);
                    }
                }
            },
            layout: { minRoomSpacing: 25 },
        },
        state: {
            mapData: null, panZoomInstance: null, isDragging: false, touchStartTarget: null, zoomInterval: null,
            layoutWorker: null
        },
        elements: {},

        init() {
            if (this.initialized) return;
            this.initialized = true;
            console.log("MapApp.init() - 核心应用初始化开始。");
            this.cacheElements(); 
            this.bindEvents();
            this.initLayoutWorker();
            this.loadDataAndRender(); // First load
            
            // Set up auto-refresh
            setInterval(() => this.loadDataAndRender(true), 30000); // Refresh every 30 seconds
        },
        initLayoutWorker() {
            const workerCode = `
                const applySimpleLayout = (locations, layoutConfig) => {
                    if (locations.length < 2) return locations;
                    const minSpacing = layoutConfig.minRoomSpacing;
                    for (let iter = 0; iter < 30; iter++) {
                        let moved = false;
                        for (let i = 0; i < locations.length; i++) {
                            for (let j = i + 1; j < locations.length; j++) {
                                const a = locations[i], b = locations[j];
                                const dx = (a.x + a.width / 2) - (b.x + b.width / 2), dy = (a.y + a.height / 2) - (b.y + b.height / 2);
                                const combinedHalfW = a.width / 2 + b.width / 2 + minSpacing, combinedHalfH = a.height / 2 + b.height / 2 + minSpacing;
                                const overlapX = combinedHalfW - Math.abs(dx), overlapY = combinedHalfH - Math.abs(dy);
                                if (overlapX > 0 && overlapY > 0) {
                                    moved = true;
                                    const move = (overlapX < overlapY ? overlapX * (dx > 0 ? 1 : -1) : overlapY * (dy > 0 ? 1 : -1)) / 2;
                                    if (overlapX < overlapY) { a.x += move; b.x -= move; } else { a.y += move; b.y -= move; }
                                }
                            }
                        }
                        if (!moved) break;
                    }
                    return locations;
                };

            self.onmessage = function(e) {
                const { locations, layoutConfig } = e.data;
                const calculatedLocations = applySimpleLayout(locations, layoutConfig);
                self.postMessage(calculatedLocations);
            };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            this.state.layoutWorker = new Worker(URL.createObjectURL(blob));
        },
        cacheElements() {
            for (const key in this.config.selectors) { this.elements[key] = document.querySelector(this.config.selectors[key]); }
            this.elements.allModals = document.querySelectorAll(this.config.selectors.modals);
        },
        showRetryButton(errorMessage) {
            const mapWrapper = document.querySelector('.map-wrapper');
            const mapInterface = document.querySelector('.map-interface');
            const container = this.elements.visualMapContainer;
            
            if(mapWrapper) mapWrapper.classList.remove('is-loading');
            if (mapInterface) mapInterface.classList.add('show');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: center; color: var(--c-text-secondary); padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                    <p style="font-weight: bold;">加载失败</p>
                    <p style="font-size: 0.9em; max-width: 80%; margin: 10px auto;">${errorMessage || '未知错误'}</p>
                    <button class="interaction-button" onclick="window.MapApp.loadDataAndRender()" style="margin-top: 15px;">点击重试</button>
                </div>
            `;
        },
        async loadDataAndRender(isSilent = false) {
            console.log(`[MapApp] 开始加载和渲染数据... (静默: ${isSilent})`);
            const mapWrapper = document.querySelector('.map-wrapper');

            if (!isSilent && mapWrapper) {
                mapWrapper.classList.add('is-loading');
            }

            try {
                const rawData = await this.config.api.getData();
                if (!rawData || typeof rawData !== 'object' || Object.keys(rawData).length === 0) {
                    throw new Error("获取到的远端数据无效或为空。");
                }
                
                this.state.mapData = this.DataProcessor.process(rawData);
                console.log('[MapApp] 数据处理完成，准备渲染...');
                this.render(isSilent);
                console.log('[MapApp] 核心渲染完成。');

                const isCollapsed = document.body.classList.contains('is-collapsed');
                const mapInterfaceEl = document.querySelector('.map-interface');
                if (mapInterfaceEl && !isCollapsed) {
                    mapInterfaceEl.classList.add('show');
                }

            } catch (error) {
                console.error("MapApp: 加载或渲染数据时失败:", error);
                this.showRetryButton(error.message);
            } finally {
                if (!isSilent && mapWrapper) {
                    mapWrapper.classList.remove('is-loading');
                }
            }
        },
        render(isSilent = false) {
            if (!this.state.mapData) return;
            
            if (!isSilent && this.state.panZoomInstance) {
                this.state.panZoomInstance.destroy();
                this.state.panZoomInstance = null;
            }

            this.Renderer.renderHeader(this.state.mapData, this.elements);
            this.elements.characterSearchInput.value = '';
            this.Renderer.renderImportantCharacters(this.state.mapData, this.elements, '');
            this.Renderer.renderExternalAreas(this.state.mapData, this.elements);
            this.Renderer.renderMap(this.state.mapData, this.elements.visualMap, this.config, isSilent);
        },
        initializePanZoomWithRetry(retryCount = 0) {
            const maxRetries = 5, container = this.elements.visualMapContainer;
            if (!container) return;
            if (document.body.classList.contains('is-collapsed') && !this.state.mapData) return;
            if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                if (retryCount < maxRetries) setTimeout(() => this.initializePanZoomWithRetry(retryCount + 1), 200);
                return;
            }
            if (typeof svgPanZoom === 'undefined') {
                if (retryCount < maxRetries) setTimeout(() => this.initializePanZoomWithRetry(retryCount + 1), 500);
                else this.UI.showAlert('地图交互库加载失败。');
                return;
            }
            this.doInitializePanZoom();
        },
        doInitializePanZoom() {
            const svg = this.elements.visualMap;
            if (this.state.panZoomInstance) this.state.panZoomInstance.destroy();
            try {
                this.state.panZoomInstance = svgPanZoom(svg, {
                    panEnabled: true, zoomEnabled: true, pinchZoomEnabled: true, controlIconsEnabled: false,
                    dblClickZoomEnabled: false, zoomScaleSensitivity: 0.2, refreshRate: 'auto',
                    contain: false, center: true, minZoom: 0.3, maxZoom: 8,
                    beforePan: function() {
                        // 在触摸事件处理期间，通过 window.event 访问事件对象。
                        // 如果检测到多于一个触摸点（例如双指缩放），则返回 false 来取消平移操作，
                        // 从而优先处理缩放手势。
                        if (window.event && window.event.touches && window.event.touches.length > 1) {
                            return false;
                        }
                        // 对于其他情况（包括鼠标拖动），不返回任何内容以允许平移
                    },
                    onPan: () => { this.state.isDragging = true; },
                    onReady: (pz) => setTimeout(() => { try { pz.fit(); pz.center(); } catch (e) {} }, 50),
                });
                this.bindMapContainerEvents(this.elements.visualMapContainer);
            } catch (error) { console.error('[MapApp] panZoom 初始化异常:', error); }
        },
        bindMapContainerEvents(container) {
            const searchInput = this.elements.characterSearchInput;
            const blurSearch = () => { if (document.activeElement === searchInput) searchInput.blur(); };
            container.addEventListener('touchstart', blurSearch, { passive: true });
            container.addEventListener('mousedown', () => { blurSearch(); container.classList.add('is-dragging');});
            window.addEventListener('mouseup', () => container.classList.remove('is-dragging'), { once: true });
        },
        bindEvents() {
            document.addEventListener('click', (event) => {
                const target = event.target, closest = (s) => target.closest(s);
                if (closest('.close-modal-button')) this.UI.closeModal(closest('.modal-overlay').id);
                else if (closest('#alert-modal-ok-btn')) this.UI.closeModal('alert-modal');
                else if (closest('#confirm-modal-cancel-btn')) this.UI.closeModal('confirm-modal');
                else if (closest('#reset-zoom-btn') && this.state.panZoomInstance) { this.state.panZoomInstance.fit(); this.state.panZoomInstance.center(); }
                else if (closest('#skill-button')) this.UI.openSkillModal();
                else if (closest('#inventory-button')) this.UI.openInventoryModal();
                else if (closest('#task-button')) this.UI.openTaskModal();
            });
            this.elements.allModals.forEach(m => m.addEventListener('click', (e) => { if (e.target === m) this.UI.closeModal(m.id); }));
            this.elements.characterSearchInput.addEventListener('input', (e) => this.Renderer.renderImportantCharacters(this.state.mapData, this.elements, e.target.value));

            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');

            const startZoom = (zoomFn) => {
                if (this.state.zoomInterval) clearInterval(this.state.zoomInterval);
                if(this.state.panZoomInstance) {
                    zoomFn(); // Immediately zoom once
                    this.state.zoomInterval = setInterval(zoomFn, 100);
                }
            };

            const stopZoom = () => {
                if (this.state.zoomInterval) {
                    clearInterval(this.state.zoomInterval);
                    this.state.zoomInterval = null;
                }
            };

            if(zoomInBtn) {
                zoomInBtn.addEventListener('mousedown', () => startZoom(() => this.state.panZoomInstance.zoomIn()));
                zoomInBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startZoom(() => this.state.panZoomInstance.zoomIn()); });
            }
            if(zoomOutBtn) {
                zoomOutBtn.addEventListener('mousedown', () => startZoom(() => this.state.panZoomInstance.zoomOut()));
                zoomOutBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startZoom(() => this.state.panZoomInstance.zoomOut()); });
            }
            
            const stopZoomEvents = ['mouseup', 'mouseleave', 'touchend'];
            stopZoomEvents.forEach(event => {
                if(zoomInBtn) zoomInBtn.addEventListener(event, stopZoom);
                if(zoomOutBtn) zoomOutBtn.addEventListener(event, stopZoom);
            });
            
            const handleMapClick = (locGroup) => {
                if (!locGroup) return;
                const locData = this.state.mapData.locations.find(loc => loc.name === locGroup.dataset.locationName);
                if (locData) this.UI.openMainLocationModal(locData);
            };
            
            this.elements.visualMap.addEventListener('mousedown', () => {
                // isDragging is now managed by the click/touchend handlers to prevent race conditions.
            });
            this.elements.visualMap.addEventListener('touchstart', (e) => {
                this.state.touchStartTarget = e.target;
                // isDragging is now managed by the click/touchend handlers.
            }, { passive: true });

            this.elements.visualMap.addEventListener('click', (e) => {
                if (!this.state.isDragging) {
                    handleMapClick(e.target.closest('.map-location-group'));
                }
                this.state.isDragging = false;
            });

            this.elements.visualMap.addEventListener('touchend', (e) => {
                if (!this.state.isDragging) {
                    const targetGroup = this.state.touchStartTarget?.closest('.map-location-group');
                    handleMapClick(targetGroup);
                }
                this.state.isDragging = false;
                this.state.touchStartTarget = null;
            });
        },
        DataProcessor: {
            process(json) {
                const tablesByName = {};
                if (!json || typeof json !== 'object') { throw new Error("无效的JSON数据。"); }
                for (const sheetId in json) { if (json[sheetId]?.name) tablesByName[json[sheetId].name] = json[sheetId]; }
                
                const data = { title: '', time: '', locations: [], importantCharacters: [], externalAreas: [], skills: [], inventory: [], tasks: [], protagonist: {}, protagonistLocationName: '', protagonistCanMove: true};
                
                const globalTable = tablesByName['全局数据表']?.content || [];
                if (globalTable.length > 1 && globalTable[1]) {
                    const [ , title, time, areas ] = globalTable[1];
                    data.title = title || '未知地图';
                    data.time = time || '未知时间';
                    data.externalAreas = (areas || '').split(';').map(s => s.trim()).filter(Boolean);
                }

                const pInfoTable = tablesByName['主角信息']?.content || [];
                const pStatusTable = tablesByName['主角状态']?.content || [];
                const pData = { isProtagonist: true, name: '主角', details: { attributes: {} }, interactions: [] };
                if (pInfoTable.length > 1 && pInfoTable[1]) Object.assign(pData, { name: pInfoTable[1][1], details: { genderAge:pInfoTable[1][2], appearance:pInfoTable[1][3], profession:pInfoTable[1][4], backstory:pInfoTable[1][5], personality:pInfoTable[1][6] }});
                if (pStatusTable.length > 1 && pStatusTable[1]) {
                    const [ , status, canMove, money, location, , p6,p7,p8,p9,p10,p11, ...interactions ] = pStatusTable[1];
                    Object.assign(pData.details, { status, money: money || '0', attributes: {'力量':p6,'智力':p7,'敏捷':p8,'体质':p9,'魅力':p10,'感知':p11} });
                    data.protagonistCanMove = !(String(canMove).trim().toLowerCase() === '否');
                    pData.currentLocationName = location || '';
                    pData.interactions = interactions.filter(Boolean);
                }
                data.protagonist = pData;
                data.importantCharacters.push(pData);
                
                (tablesByName['重要人物表']?.content || []).slice(1).forEach(r => {
                    if (!r || !r[1]) return;
                    const [ , name, genderAge, appearance, profession, personality, backstory, relationship, status, items, abilities, affinity, thoughts, ...interactions ] = r;
                    data.importantCharacters.push({ name, genderAge, appearance, profession, personality, backstory, relationship, status, items, abilities, affinity, thoughts, interactions: interactions.slice(0, 4).filter(Boolean), isAway: r[17] === 'true', awayTurns: r[18], isPlotCritical: r[19], avatar: r[20]});
                });

                (tablesByName['主角技能表']?.content || []).slice(1).forEach(r => r?.[1] && data.skills.push({ name: r[1], effect: r[2], level: r[3], mastery: r[4] }));
                (tablesByName['背包物品表']?.content || []).slice(1).forEach(r => r?.[1] && data.inventory.push({ name: r[1], quantity: r[2], description: r[3], isNew: r[4] === 'true' }));
                (tablesByName['任务与事件表']?.content || []).slice(1).forEach(r => r?.[1] && data.tasks.push({ name: r[1], description: r[2], progress: r[5], isUpdated: r[6] === 'true' }));

                const subLocs = {};
                (tablesByName['次级地点表']?.content || []).slice(1).forEach(r => { if(r?.[2] && r?.[1]) { if(!subLocs[r[2]]) subLocs[r[2]] = []; subLocs[r[2]].push({ name: r[1], description: r[3], elements: [] }); }});
                
                (tablesByName['地图元素表']?.content || []).slice(1).forEach(r => {
                    if(!r?.[1] || !r?.[4]) return;
                    for (const mainLocName in subLocs) {
                        const sub = subLocs[mainLocName].find(i => i.name === r[4]);
                        if (sub) {
                            sub.elements.push({ name: r[1], type: r[2], description: r[3], interactions: [r[7], r[8], r[9], r[10]].filter(Boolean) });
                            break;
                        }
                    }
                });

                (tablesByName['主要地点表']?.content || []).slice(1).forEach(r => {
                    if(!r?.[1]) return;
                    const [x, y, w, h] = [r[2], r[3], r[4], r[5]].map(v => parseInt(v));
                    if([x, y, w, h].every(v => !isNaN(v))) {
                        data.locations.push({ name: r[1], x, y, width: w, height: h, type: r[6], description: r[7], subLocations: subLocs[r[1]] || [] });
                    }
                });

                data.protagonistLocationName = pData.currentLocationName || (data.locations[0]?.name || '');
                return data;
            }
        },
        Renderer: {
            renderHeader(data, elements) {
                elements.mapTitle.textContent = data.title;
                elements.mapTime.textContent = data.time;
            },
            renderMap(data, svgElement, config, isSilent = false) {
                if (!data.locations || data.locations.length === 0) {
                    svgElement.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="currentColor" style="font-family: var(--font-ui);">没有地点数据</text>';
                    svgElement.setAttribute('viewBox', '0 0 800 600');
                    return;
                }

                this.applySimpleLayout(JSON.parse(JSON.stringify(data.locations)), config.layout)
                    .then(locations => {
                        const ns = "http://www.w3.org/2000/svg";
                        const bounds = this.calculateBounds(locations);
                        const padding = Math.max(bounds.width, bounds.height) * 0.1;
                        svgElement.setAttribute('viewBox', `${bounds.x - padding} ${bounds.y - padding} ${bounds.width + padding*2} ${bounds.height + padding*2}`);
                
                        if (!svgElement.querySelector('defs')) {
                            const defs = this.createSVGElement(ns, 'defs', {});
                            defs.innerHTML = `<linearGradient id="locationGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" class="gradient-stop-1"/><stop offset="100%" class="gradient-stop-2"/></linearGradient>`;
                            svgElement.prepend(defs);
                        }
                
                        const existingElements = new Map();
                        svgElement.querySelectorAll('.map-location-group').forEach(el => {
                            existingElements.set(el.dataset.locationName, el);
                        });
                
                        const locationsToUpdate = locations;
                        const CHUNK_SIZE = 8; // 每帧更新的元素数量
                        let currentIndex = 0;
                
                        const updateChunkByFrame = () => {
                            const chunk = locationsToUpdate.slice(currentIndex, currentIndex + CHUNK_SIZE);
                            
                            chunk.forEach(loc => {
                                const existingEl = existingElements.get(loc.name);
                                if (existingEl) {
                                    this.updateMapLocation(existingEl, loc, data.protagonistLocationName);
                                    existingElements.delete(loc.name);
                                } else {
                                    const newEl = this.createMapLocation(loc, data.protagonistLocationName, ns);
                                    svgElement.appendChild(newEl);
                                }
                            });
                
                            currentIndex += CHUNK_SIZE;
                
                            if (currentIndex < locationsToUpdate.length) {
                                requestAnimationFrame(updateChunkByFrame);
                            } else {
                                existingElements.forEach(el => el.remove());
                                console.log("所有地点分帧更新完成。");
                                if (!isSilent && window.MapApp?.initializePanZoomWithRetry) {
                                    window.MapApp.initializePanZoomWithRetry();
                                } else if (isSilent && window.MapApp?.state.panZoomInstance) {
                                    window.MapApp.state.panZoomInstance.updateBBox();
                                }
                            }
                        };
                        
                        requestAnimationFrame(updateChunkByFrame);
                    })
                    .catch(error => {
                        console.error("Layout calculation failed:", error);
                        svgElement.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="red">布局计算失败</text>';
                    });
            },
            applySimpleLayout(locations, layoutConfig) {
                return new Promise((resolve, reject) => {
                    const worker = window.MapApp.state.layoutWorker;
                    if (!worker) {
                        return reject(new Error("Layout worker not initialized."));
                    }

                    worker.onmessage = (e) => {
                        resolve(e.data);
                    };

                    worker.onerror = (e) => {
                        reject(new Error(`Layout Worker Error: ${e.message}`));
                    };

                    worker.postMessage({ locations, layoutConfig });
                });
            },
            calculateBounds(locations) {
                if (!locations.length) return { x: 0, y: 0, width: 800, height: 600 };
                const xCoords = locations.flatMap(l => [l.x, l.x + l.width]);
                const yCoords = locations.flatMap(l => [l.y, l.y + l.height]);
                const minX = Math.min(...xCoords), maxX = Math.max(...xCoords);
                const minY = Math.min(...yCoords), maxY = Math.max(...yCoords);
                return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };
            },
            updateMapLocation(g, loc, protagonistLocationName) {
                g.classList.toggle('is-current-location', loc.name === protagonistLocationName);
                g.style.setProperty('--room-area', `${loc.width * loc.height}`);
                
                const rect = g.querySelector('.map-location-rect');
                rect.setAttribute('x', loc.x);
                rect.setAttribute('y', loc.y);
                rect.setAttribute('width', loc.width);
                rect.setAttribute('height', loc.height);
                rect.setAttribute('rx', Math.min(loc.width, loc.height) * 0.1);
            
                const label = g.querySelector('.map-location-label');
                label.setAttribute('x', loc.x + loc.width / 2);
                label.setAttribute('y', loc.y + loc.height / 2);
                if (label.textContent !== loc.name) {
                    label.textContent = loc.name;
                }
            
            },
            createMapLocation(loc, protagonistLocationName, ns) {
                const g = this.createSVGElement(ns, 'g', { 'class': 'map-location-group', 'data-location-name': loc.name });
                const rect = this.createSVGElement(ns, 'rect', { 'class': 'map-location-rect' });
                const label = this.createSVGElement(ns, 'text', { 'class': 'map-location-label' });
                g.append(rect, label);
                this.updateMapLocation(g, loc, protagonistLocationName);
                return g;
            },
            renderImportantCharacters(data, elements, filterText = '') {
                const container = elements.importantCharsContainer, section = elements.importantCharsSection, fragment = document.createDocumentFragment();
                const lowerFilter = filterText.toLowerCase();
                const contactableChars = data.importantCharacters.filter(c => !c.isAway || c.isProtagonist);
                const charsToRender = filterText ? contactableChars.filter(c => c.name.toLowerCase().includes(lowerFilter)) : contactableChars;
                
                if (charsToRender.length > 0) {
                    charsToRender.forEach(char => {
                        const btn = document.createElement('button');
                        btn.className = 'partner-button';
                        btn.onclick = () => window.MapApp.UI.openCharacterModal(char);
                        const avatar = char.avatar && char.avatar.startsWith('http') ? `<img src="${char.avatar}" class="avatar" alt="${char.name}" onerror="this.style.display='none'; this.nextSibling.style.display='flex';"> <div class="avatar avatar-fallback" style="display:none;">${char.name.substring(0, 1)}</div>` : `<div class="avatar avatar-fallback">${char.name.substring(0, 1)}</div>`;
                        btn.innerHTML = `${avatar}<span>${char.name}</span>`; 
                        fragment.appendChild(btn);
                    });
                } else if (filterText) {
                    const p = document.createElement('p'); p.style.cssText = 'color: var(--c-text-secondary); width: 100%; text-align: center;'; p.textContent = '未找到人物'; fragment.appendChild(p);
                }
                container.replaceChildren(fragment);
                section.classList.toggle('hidden', contactableChars.length === 0);
                window.MapApp.UI.staggeredEntrance('#important-character-buttons', '.partner-button');
            },
            renderExternalAreas(data, elements) {
                const container = elements.externalAreasContainer, section = elements.externalAreasSection, fragment = document.createDocumentFragment();
                if (data.externalAreas.length > 0) {
                    data.externalAreas.forEach(area => {
                        const btn = document.createElement('button'); btn.className = 'external-area-button';
                        btn.innerHTML = `<i class="fas fa-globe-asia"></i> ${area}`;
                        btn.onclick = (e) => window.MapApp.Actions.travelTo(area, e);
                        fragment.appendChild(btn);
                    });
                    section.classList.remove('hidden');
                } else { section.classList.add('hidden'); }
                container.replaceChildren(fragment);
            },
            createSVGElement: (ns, tag, attrs) => { const el = document.createElementNS(ns, tag); for(let k in attrs) el.setAttribute(k, attrs[k]); return el; },
        },
        UI: {
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.error(`[MapApp] 尝试打开一个不存在的弹窗: #${modalId}`);
                    return;
                }
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                document.body.style.setProperty('--scrollbar-width', `${scrollbarWidth}px`);
                document.body.classList.add('modal-open');
                
                modal.classList.remove('hidden');
            },
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.error(`[MapApp] 尝试关闭一个不存在的弹窗: #${modalId}`);
                    return;
                }
                modal.classList.add('hidden');
                if (!document.querySelector('.modal-overlay:not(.hidden)')) {
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('--scrollbar-width');
                    
                    if (window.MapApp && window.MapApp.state.panZoomInstance) {
                        setTimeout(() => {
                            try {
                                window.MapApp.state.panZoomInstance.resize();
                                window.MapApp.state.panZoomInstance.fit();
                                window.MapApp.state.panZoomInstance.center();
                            } catch(e) {
                                console.error("Error resizing pan-zoom instance after modal close:", e);
                            }
                        }, 350);
                    }
                }
            },
            showAlert(message) {
                const textElement = document.getElementById('alert-modal-text');
                if (textElement) {
                    textElement.textContent = message;
                    this.openModal('alert-modal');
                }
            },
            showConfirm(actionText, onConfirm) {
                const modal = document.getElementById('confirm-modal');
                if (!modal) return;
                
                modal.querySelector('#confirm-modal-text').innerHTML = `<span style="display: block; margin-bottom: 8px;">您是否要执行以下操作？</span><strong style="color: var(--c-accent-primary);">${actionText}</strong>`;
                
                const confirmBtn = modal.querySelector('#confirm-modal-confirm-btn');
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                
                newBtn.onclick = () => {
                    this.closeModal('confirm-modal');
                    if (typeof onConfirm === 'function') {
                        onConfirm();
                    }
                };
                this.openModal('confirm-modal');
            },
            staggeredEntrance(containerSel, itemSel) {
                const container = document.querySelector(containerSel);
                if (!container) return;

                const items = container.querySelectorAll(itemSel);
                items.forEach((item, index) => {
                    // ✨ 优化：先清除旧的动画类和样式，确保每次都是干净的开始
                    item.classList.remove('list-item-enter', 'list-item-enter-active');
                    item.style.transitionDelay = '';

                    // 应用新的入场动画
                    requestAnimationFrame(() => {
                        item.classList.add('list-item-enter');
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                item.style.transitionDelay = `${index * 50}ms`;
                                item.classList.add('list-item-enter-active');
                            }, 20);
                        });
                    });
                });
            },

            createItemListModal(modalId, containerId, items, emptyText, itemClass, itemFactory) {
                this.openModal(modalId);
                const container = document.getElementById(containerId);
                const fragment = this.createItemList(items, emptyText, itemClass, itemFactory);
                container.replaceChildren(fragment);
                this.staggeredEntrance(`#${containerId}`, `.${itemClass}`);
            },

            openSkillModal() {
                this.createItemListModal(
                    'skill-modal',
                    'skill-items-container',
                    window.MapApp.state.mapData?.skills,
                    '无技能',
                    'skill-item',
                    (skill) => ({
                        html: `<div><strong>${skill.name} (Lv.${skill.level})</strong><br><small>${skill.effect}</small></div>`,
                        action: (e) => window.MapApp.Actions.useSkill(skill.name, e)
                    })
                );
            },

            openInventoryModal() {
                this.createItemListModal(
                    'inventory-modal',
                    'inventory-items-container',
                    window.MapApp.state.mapData?.inventory,
                    '背包为空',
                    'inventory-item',
                    (item) => ({
                        html: `<div><strong>${item.name} (×${item.quantity})</strong><br><small>${item.description}</small></div>`,
                        action: (e) => window.MapApp.Actions.useItem(item.name, e)
                    })
                );
            },

            createItemList(items, emptyText, itemClass, itemFactory) {
                const fragment = document.createDocumentFragment();
                if (!items || items.length === 0) {
                    const p = document.createElement('p');
                    p.className = 'modal-empty-state';
                    p.textContent = emptyText;
                    fragment.appendChild(p);
                } else {
                    items.forEach(item => {
                        const itemData = itemFactory(item);
                        const div = document.createElement('div');
                        
                        div.className = itemClass; 
                        if (item.isNew) {
                            div.classList.add('new-item');
                        }

                        if (itemData.action) {
                           div.innerHTML = `${itemData.html}<button class="use-button">使用</button>`;
                           div.querySelector('.use-button').onclick = itemData.action;
                        } else {
                           div.innerHTML = itemData.html;
                        }
                        
                        fragment.appendChild(div);
                    });
                }
                return fragment;
            },
            
            openTaskModal() {
                this.openModal('task-modal');
                const container = document.getElementById('task-items-container');
                const tasks = window.MapApp.state.mapData?.tasks || [];
                if (tasks.length === 0) {
                    const p = document.createElement('p');
                    p.className = 'modal-empty-state';
                    p.textContent = '没有进行中的任务';
                    container.replaceChildren(p);
                } else {
                    const fragment = document.createDocumentFragment();
                    tasks.forEach(task => {
                        const item = document.createElement('div');
                        item.className = 'task-item';
                        item.innerHTML = `<div class="task-item-header">${task.name}</div><div class="task-item-details"><p>描述: ${task.description}</p><p>进度: ${task.progress}</p></div>`;
                        fragment.appendChild(item);
                    });
                    container.replaceChildren(fragment);
                }
                this.staggeredEntrance('#task-items-container', '.task-item');
            },
            openCharacterModal(char) {
                this.openModal('character-modal');
                const modal = document.getElementById('character-modal'),
                    nameEl = modal.querySelector('#modal-character-name'),
                    descEl = modal.querySelector('#modal-character-description'),
                    interactEl = modal.querySelector('#modal-interaction-options');
                nameEl.textContent = char.name;
                const details = char.isProtagonist ? [{
                    l: '属性',
                    v: char.details.attributes,
                    t: 'grid'
                }, {
                    l: '性别/年龄',
                    v: char.details.genderAge
                }, {
                    l: '外貌',
                    v: char.details.appearance
                }, {
                    l: '职业',
                    v: char.details.profession
                }, {
                    l: '背景',
                    v: char.details.backstory
                }, {
                    l: '性格',
                    v: char.details.personality
                }, {
                    l: '状态',
                    v: char.details.status
                }] : [{
                    l: '性别/年龄',
                    v: char.genderAge
                }, {
                    l: '外貌',
                    v: char.appearance
                }, {
                    l: '职业',
                    v: char.profession
                }, {
                    l: '性格',
                    v: char.personality
                }, {
                    l: '背景',
                    v: char.backstory
                }, {
                    l: '关系',
                    v: char.relationship
                }, {
                    l: '状态',
                    v: char.status
                }, {
                    l: '好感度',
                    v: char.affinity
                }];
                const descFrag = document.createDocumentFragment();
                details.forEach(d => {
                    if (!d.v) return;
                    if (d.t === 'grid') {
                        const grid = document.createElement('div');
                        grid.className = 'attributes-grid';
                        for (const key in d.v)
                            if (d.v[key]) {
                                const item = document.createElement('div');
                                item.className = 'attribute-item';
                                item.innerHTML = `<div class="attribute-item-label">${key}</div><div class="attribute-item-value">${d.v[key]}</div>`;
                                grid.appendChild(item);
                            } descFrag.appendChild(grid);
                    } else {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>${d.l}:</strong> ${d.v}`;
                        descFrag.appendChild(p);
                    }
                });
                descEl.replaceChildren(descFrag);
                const interactFrag = document.createDocumentFragment();
                if (char.interactions?.length > 0) char.interactions.forEach(text => {
                    const btn = document.createElement('button');
                    btn.className = 'interaction-button';
                    btn.textContent = text;
                    btn.onclick = (e) => {
                        this.closeModal('character-modal');
                        window.MapApp.Actions.interactWith(char.name, text, e);
                    };
                    interactFrag.appendChild(btn);
                });
                else {
                    const p = document.createElement('p');
                    p.style.cssText = 'text-align:center;color:var(--c-text-secondary);';
                    p.textContent = '无可用互动';
                    interactFrag.appendChild(p);
                }
                interactEl.replaceChildren(interactFrag);
                this.staggeredEntrance('#modal-interaction-options', '.interaction-button');
            },
            openMainLocationModal(loc) {
                const nameEl = document.getElementById('modal-main-loc-name'),
                    contentEl = document.getElementById('modal-main-loc-content'),
                    actionsEl = document.getElementById('modal-main-loc-actions');
                nameEl.textContent = loc.name;
                contentEl.innerHTML = `<p style="text-align:center; color: var(--c-text-secondary);">${loc.description || '无描述'}</p>`;
                actionsEl.innerHTML = '';
                if (loc.name !== window.MapApp.state.mapData.protagonistLocationName) {
                    const btn = document.createElement('button');
                    btn.className = 'interaction-button';
                    btn.textContent = '移动到这里';
                    btn.onclick = (e) => {
                        this.closeModal('main-location-modal');
                        window.MapApp.Actions.travelTo(loc.name, e);
                    };
                    actionsEl.appendChild(btn);
                }
                if (loc.subLocations?.length > 0) {
                    const title = document.createElement('h5');
                    title.className = 'modal-section-title';
                    title.textContent = '可探索区域';
                    contentEl.appendChild(title);
                    const grid = document.createElement('div');
                    grid.className = 'sub-location-grid';
                    loc.subLocations.forEach(sub => {
                        const btn = document.createElement('button');
                        btn.className = 'sub-location-button';
                        btn.textContent = sub.name;
                        btn.onclick = () => {
                            this.closeModal('main-location-modal');
                            this.openSubLocationModal(sub);
                        };
                        grid.appendChild(btn);
                    });
                    contentEl.appendChild(grid);
                }
                this.openModal('main-location-modal');
            },
            openSubLocationModal(subLoc) {
                this.openModal('sub-location-modal');
                const nameEl = document.getElementById('modal-sub-loc-name'),
                    contentEl = document.getElementById('modal-sub-loc-content');
                nameEl.textContent = subLoc.name;
                contentEl.innerHTML = `<p style="text-align:center; color: var(--c-text-secondary);">${subLoc.description || '无描述'}</p>`;
                if (subLoc.elements?.length > 0) {
                    const title = document.createElement('h5');
                    title.className = 'modal-section-title';
                    title.textContent = '可互动元素';
                    contentEl.appendChild(title);
                    const grid = document.createElement('div');
                    grid.className = 'sub-location-grid';
                    subLoc.elements.forEach(el => {
                        const btn = document.createElement('button');
                        btn.className = 'sub-location-button';
                        btn.textContent = el.name;
                        btn.onclick = () => {
                            this.closeModal('sub-location-modal');
                            this.openMapElementModal(el);
                        };
                        grid.appendChild(btn);
                    });
                    contentEl.appendChild(grid);
                }
            },
            openMapElementModal(element) {
                this.openModal('map-element-modal');
                const nameEl = document.getElementById('modal-element-name'),
                    descEl = document.getElementById('modal-element-description'),
                    interactEl = document.getElementById('modal-element-interactions');
                nameEl.textContent = element.name;
                descEl.innerHTML = `<p>${element.description || '一个普通的物件。'}</p>`;
                interactEl.innerHTML = '';
                if (element.interactions?.length > 0) {
                    const frag = document.createDocumentFragment();
                    element.interactions.forEach(text => {
                        const btn = document.createElement('button');
                        btn.className = 'interaction-button';
                        btn.textContent = text;
                        btn.onclick = (e) => {
                            this.closeModal('map-element-modal');
                            window.MapApp.Actions.interactWith(element.name, text, e);
                        };
                        frag.appendChild(btn);
                    });
                    interactEl.appendChild(frag);
                } else {
                    interactEl.innerHTML = '<p style="text-align:center; color: var(--c-text-secondary);">无可用互动</p>';
                }
            },
        },

        Actions: {
            sendRequest(actionText, command, event) {
                const btn = event?.target.closest('button');
                window.MapApp.UI.showConfirm(actionText, () => {
                    if (btn) { btn.classList.add('is-loading'); btn.disabled = true; }
                    window.MapApp.config.api.sendCommand(command);
                });
            },
            travelTo(loc, e) { this.sendRequest(`移动到 ${loc}`, `<request:{{user}}移动到${loc}>`, e); },
            useSkill(skill, e) { this.sendRequest(`使用技能: ${skill}`, `<request:{{user}}使用技能${skill}>`, e); },
            useItem(item, e) { this.sendRequest(`使用物品: ${item}`, `<request:{{user}}使用物品${item}>`, e); },
            interactWith(target, action, e) { this.sendRequest(`对 ${target} 执行: ${action}`, `<request:{{user}}对${target}执行互动:${action}>`, e); }
        }
    };
    




    
    /**
     * =========================================================================
     * 安全初始化器
     * =========================================================================
     */
const SafeMapAppInitializer = {
    initialized: false,
    checkInterval: null,
    checkCount: 0,
    maxChecks: 3, 

    init() {
        console.log('[MapApp] 安全初始化器启动');
        
        const startChecking = () => {
            if (this.checkInterval) clearInterval(this.checkInterval);
            this.checkAndInit();
            this.checkInterval = setInterval(() => this.checkAndInit(), 3000); 
        };

        if (!window.MapAppLibrariesReady) {
            window.addEventListener('mapAppLibrariesReady', () => {
                console.log('[MapApp] 依赖库已就绪，开始检查初始化条件');
                startChecking();
            }, { once: true });
            
            setTimeout(() => {
                if (!this.initialized) {
                    console.log('[MapApp] 库加载超时，强制开始检查');
                    startChecking();
                }
            }, 5000);
        } else {
            startChecking();
        }
    },
    
    checkAndInit() {
        if (this.initialized) {
            this.stopChecking();
            return;
        }

        if (this.isWelcomePage()) {
            console.log('[MapApp] 检测到欢迎页面，隐藏地图。');
            const pageCollapser = document.querySelector('.page-collapser');
            if (pageCollapser) pageCollapser.style.display = 'none';
            return;
        } else {
            const pageCollapser = document.querySelector('.page-collapser');
            if (pageCollapser) pageCollapser.style.display = '';
        }

        this.checkCount++;
        console.log(`[MapApp] 安全检查 第 ${this.checkCount}/${this.maxChecks} 次...`);

        if (typeof parent.stMemoryEnhancement?.ext_exportAllTablesAsJson === 'function') {
            console.log('%c[MapApp] 环境检查通过，开始执行初始化...', 'color: #28a745; font-weight: bold;');
            this.performInitialization();
            this.stopChecking(); 
            return;
        }

        if (this.checkCount > this.maxChecks) {
            console.log('[MapApp] 达到最大检查次数，停止自动初始化。');
            if (!this.initialized) {
                MapApp.showRetryButton("地图初始化超时。请确认您当前在角色对话页面，且记忆插件已启用。");
            }
            this.stopChecking();
        }
    },

    isWelcomePage() {
        try {
            if (window.self === window.top) return false;
            
            const messages = parent.document.querySelectorAll('#chat .mes');
            if (messages.length === 0) return true;
            
            const lastMessage = messages[messages.length - 1];
            const nameElement = lastMessage.querySelector('span.name_text');
            
            if (!nameElement) return true;
            
            const speakerName = nameElement.textContent.trim();
            const welcomeSpeakers = ['Assistant', 'SillyTavern System'];

            return welcomeSpeakers.includes(speakerName);

        } catch (e) {
            return true;
        }
    },

    performInitialization() {
        try {
            this.initialized = true;
            console.log('%c[MapApp] MapApp.init() 被调用，地图正在加载...', 'color: #007bff; font-weight: bold;');
            window.MapApp.init();
        } catch (error) {
            console.error('[MapApp] 初始化过程中发生严重错误:', error);
            this.initialized = false; // Allow re-initialization
            MapApp.showRetryButton(`初始化失败: ${error.message}`);
        }
    },
    
    stopChecking() {
        if (this.checkInterval) {
            clearInterval(this.checkInterval);
            this.checkInterval = null;
            console.log('[MapApp] 定时检查已停止。');
        }
    },
        
    forceCheck() {
        console.log('[MapApp] 手动触发重新检查...');
        this.onPageChange();
    }
};

    document.addEventListener('DOMContentLoaded', () => {
        console.log('[MapApp] DOM 已加载，开始统一初始化流程。');
        DOMManager.init();
    });
</script>


</body>
</html>

```
